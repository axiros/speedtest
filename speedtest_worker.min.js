/*
    HTML5 Speedtest v4.1
    by Federico Dossena
    https://github.com/adolfintel/speedtest/
    GNU LGPLv3 License
*///data reported to main thread
function clearRequests(){var e="onprogress",t=null,n="upload";if(xhr){for(var r=0;r<xhr.length;r++){if(useFetchAPI)try{xhr[r].cancelRequested=!0}catch(i){}try{xhr[r][e]=t,xhr[r].onload=t,xhr[r].onerror=t}catch(i){}try{xhr[r][n][e]=t,xhr[r][n].onload=t,xhr[r][n].onerror=t}catch(i){}try{xhr[r].abort()}catch(i){}try{delete xhr[r]}catch(i){}}xhr=t}}function getIp(e){xhr=new XMLHttpRequest,xhr.onload=function(){clientIp=xhr.responseText,e()},xhr.onerror=function(){e()},xhr.open("GET",settings.url_getIp+"?r="+Math.random(),!0),xhr.send()}function getServer(e){var t="Fail",n="setRequestHeader",r="application/json";if(!settings.enable_multiPots)return e();var i={},s=[],o="";xhr=new XMLHttpRequest,xhr.onload=function(){var n=JSON.parse(xhr.responseText),r=n.routes;pointsOfTest=n.result;var u=function(e){var n=(new Date).getTime();xhr=new XMLHttpRequest,xhr.onload=function(){var e=(new Date).getTime();o=e-n,o=o.toFixed(2)},xhr.onerror=function(){o=t},xhr.open("GET",e,!1),xhr.send()};for(var a=0;a<pointsOfTest.length;a++){try{u(pointsOfTest[a])}catch(f){o=t}o!=t&&(i[o]=pointsOfTest[a],s.push(o))}s.sort(function(e,t){return e-t}),pot=i[s[0]],settings.url_ping=pot,settings.url_dl=pot+r.download,settings.url_ul=pot+r.upload,console.log("Available servers:"+JSON.stringify(i)),console.log("Best point of test: "+pot),e()},xhr.onerror=function(){e()},xhr.open("POST",settings.url_getPointsOfTest,!0),xhr[n]("Content-Type",r),xhr[n]("Accept",r),xhr.send(JSON.stringify({data:{}}))}function dlTest(e){var t=!0,n="bind",r="garbagePhp_chunkSize",i="loaded",s="responseType";if(dlCalled)return;dlCalled=t;var o=0,u=(new Date).getTime(),a=!1;xhr=[];var f=function(e,u){setTimeout(function(){if(testStatus!=1)return;if(useFetchAPI){var u=settings.url_dl+settings[r]+"?r="+Math.random();xhr[e]=fetch(u).then(function(t){var r=t.body.getReader(),i=function(){return r.read().then(function(t){return t.done?f(e):(o+=t.value.length,xhr[e].cancelRequested&&r.cancel()),i()}[n](this))}[n](this);return i()}[n](this))}else{var l=0,c=new XMLHttpRequest;xhr[e]=c,xhr[e].onprogress=function(e){if(testStatus!=1)try{c.abort()}catch(t){}var n=e[i]<=0?0:e[i]-l;if(isNaN(n)||!isFinite(n)||n<0)return;o+=n,l=e[i]}[n](this),xhr[e].onload=function(){try{xhr[e].abort()}catch(t){}f(e,0)}[n](this),xhr[e].onerror=function(){a=t;try{xhr[e].abort()}catch(n){}delete xhr[e]}[n](this);try{settings.xhr_dlUseBlob?xhr[e][s]="blob":xhr[e][s]="arraybuffer"}catch(h){}var u=settings.url_dl+settings[r]+"?r="+Math.random();xhr[e].open("GET",u,t),xhr[e].send()}}[n](this),1+u)}[n](this);for(var l=0;l<settings.xhr_dlMultistream;l++)f(l,100*l);interval=setInterval(function(){var t=(new Date).getTime()-u;if(t<200)return;var n=o/(t/1e3);dlStatus=(n*8/925e3).toFixed(2);if(t/1e3>settings.time_dl||a){if(a||isNaN(dlStatus))dlStatus="Fail";clearRequests(),clearInterval(interval),e()}}[n](this),200)}function ulTest(e){var t=!0,n="bind",r="onprogress",i="upload",s="POST",o="setRequestHeader",u="Content-Encoding",a="identity",f="loaded";if(ulCalled)return;ulCalled=t;var l=0,c=(new Date).getTime(),h=!1;xhr=[];var p=function(e,c){setTimeout(function(){if(testStatus!=3)return;var c=0,d=new XMLHttpRequest;xhr[e]=d;var v;try{xhr[e][i][r],v=!1}catch(m){v=t}v?(xhr[e].onload=function(){l+=262144,p(e,0)},xhr[e].onerror=function(){h=t;try{xhr[e].abort()}catch(n){}delete xhr[e]},xhr[e].open(s,settings.url_ul+"?r="+Math.random(),t),xhr[e][o](u,a),xhr[e].send(reqsmall)):(xhr[e][i][r]=function(e){if(testStatus!=3)try{d.abort()}catch(t){}var n=e[f]<=0?0:e[f]-c;if(isNaN(n)||!isFinite(n)||n<0)return;l+=n,c=e[f]}[n](this),xhr[e][i].onload=function(){p(e,0)}[n](this),xhr[e][i].onerror=function(){h=t;try{xhr[e].abort()}catch(n){}delete xhr[e]}[n](this),xhr[e].open(s,settings.url_ul+"?r="+Math.random(),t),xhr[e][o](u,a),xhr[e].send(req))}[n](this),1)}[n](this);for(var d=0;d<settings.xhr_ulMultistream;d++)p(d,100*d);interval=setInterval(function(){var t=(new Date).getTime()-c;if(t<200)return;var n=l/(t/1e3);ulStatus=(n*8/925e3).toFixed(2);if(t/1e3>settings.time_ul||h){if(h||isNaN(ulStatus))ulStatus="Fail";clearRequests(),clearInterval(interval),e()}}[n](this),200)}function pingTest(e){if(ptCalled)return;ptCalled=!0;var t=null,n=0,r=0,i=0,s=0;xhr=[];var o=function(){t=(new Date).getTime(),xhr[0]=new XMLHttpRequest,xhr[0].onload=function(){if(i==0)t=(new Date).getTime();else{var u=((new Date).getTime()-t)/2,a=Math.abs(u-s);i==1?n=u:(n=n*.9+u*.1,r=a>r?r*.2+a*.8:r*.9+a*.1),s=u}pingStatus=n.toFixed(2),jitterStatus=r.toFixed(2),i++,i<settings.count_ping?o():e()}.bind(this),xhr[0].onerror=function(){packetLoss+=1}.bind(this),xhr[0].open("GET",settings.url_ping+"?r="+Math.random(),!0),xhr[0].send()}.bind(this);o()}function ispInfo(e){var t="hasOwnProperty",n="country",r="region";try{xhr=new XMLHttpRequest,xhr.onload=function(){var i=JSON.parse(xhr.responseText);i[t]("ip")&&(clientIp=i.ip),i[t](n)&&(country=i[n]),i[t](r)&&(region=i[r]),i[t]("org")&&(isp=i.org),e()},xhr.onerror=function(){e()},xhr.open("GET",settings.url_ispInfo,!0),xhr.setRequestHeader("Accept","application/json"),xhr.send()}catch(i){console.log(i.message)}}function saveResult(e){var t="setRequestHeader",n="application/json";if(testStatus!=4)return;xhr=new XMLHttpRequest,xhr.onload=function(){var e=JSON.parse(xhr.responseText)},xhr.onerror=function(){},xhr.open("POST",settings.url_saveResult,!0),xhr[t]("Content-Type",n),xhr[t]("Accept",n),xhr.send(JSON.stringify({data:e}))}var testStatus=0,dlStatus="",ulStatus="",pingStatus="",jitterStatus="",clientIp="",pot="",packetLoss=0,country="",region="",isp="",settings={time_ul:15,time_dl:15,count_ping:35,url_dl:"/download/",url_ul:"empty.dat",url_ping:"empty.dat",url_getIp:"/ip",url_getPointsOfTest:"/pots",url_saveResult:"/save",url_ispInfo:"http://ipinfo.io",xhr_dlMultistream:10,xhr_ulMultistream:3,xhr_dlUseBlob:!1,garbagePhp_chunkSize:20,enable_quirks:!0,enable_multiPots:!1,allow_fetchAPI:!1,force_fetchAPI:!1},xhr=null,interval=null,useFetchAPI=!1;this.addEventListener("message",function(e){var t=";",n="url_getPointsOfTest",r="undefined",i="url_saveResult",s="url_dl",o="url_ul",u="url_ping",a="url_getIp",f="time_dl",l="time_ul",c="enable_quirks",h="allow_fetchAPI",p="test",d="xhr_ulMultistream",v="xhr_dlMultistream",m="garbagePhp_chunkSize",g="count_ping",y="xhr_dlUseBlob",b="force_fetchAPI",w=e.data.split(" "),E="";try{E=navigator.userAgent}catch(e){console.log(e.message)}w[0]=="status"&&(postMessage(testStatus+t+dlStatus+t+ulStatus+t+pingStatus+t+clientIp+t+jitterStatus+t+pot+t+packetLoss+t+country+t+region+t+isp+t+E),saveResult({download:dlStatus,upload:ulStatus,ping:pingStatus,jitter:jitterStatus,packetloss:packetLoss,pot:pot,useragent:E,country:country,region:region,isp:isp}));if(w[0]=="start"&&testStatus==0){testStatus=1;try{var S=JSON.parse(e.data.substring(5));typeof S[n]!=r&&(settings[n]=S[n]),typeof S[i]!=r&&(settings[i]=S[i]),typeof S[s]!=r&&(settings[s]=S[s]),typeof S[o]!=r&&(settings[o]=S[o]),typeof S[u]!=r&&(settings[u]=S[u]),typeof S[a]!=r&&(settings[a]=S[a]),typeof S[f]!=r&&(settings[f]=S[f]),typeof S[l]!=r&&(settings[l]=S[l]),typeof S[c]!=r&&(settings[c]=S[c]),typeof S[h]!=r&&(settings[h]=S[h]);if(settings[c]){var x=navigator.userAgent;/Firefox.(\d+\.\d+)/i[p](x)&&(settings[d]=1),/Edge.(\d+\.\d+)/i[p](x)&&(settings[v]=3),/Safari.(\d+)/i[p](x)&&!/Chrome.(\d+)/i[p](x)&&(settings[d]=10,settings[m]=5),/Chrome.(\d+)/i[p](x)&&!!self.fetch&&(settings[h]&&(useFetchAPI=!0),settings[v]=5)}typeof S[g]!=r&&(settings[g]=S[g]),typeof S[v]!=r&&(settings[v]=S[v]),typeof S[d]!=r&&(settings[d]=S[d]),typeof S[y]!=r&&(settings[y]=S[y]),typeof S[m]!=r&&(settings[m]=S[m]),typeof S[b]!=r&&(settings[b]=S[b]),settings[h]&&settings[b]&&!!self.fetch&&(useFetchAPI=!0)}catch(e){}console.log(settings),console.log("Fetch API: "+useFetchAPI),getServer(function(){ispInfo(function(){dlTest(function(){testStatus=2,pingTest(function(){testStatus=3,ulTest(function(){testStatus=4})})})})})}w[0]=="abort"&&(clearRequests(),interval&&clearInterval(interval),testStatus=5,dlStatus="",ulStatus="",pingStatus="",jitterStatus="",pot="")});var dlCalled=!1,r=new ArrayBuffer(1048576);try{r=new Float32Array(r);for(var i=0;i<r.length;i++)r[i]=Math.random()}catch(e){}var req=[],reqsmall=[];for(var i=0;i<20;i++)req.push(r);req=new Blob(req),r=new ArrayBuffer(262144);try{r=new Float32Array(r);for(var i=0;i<r.length;i++)r[i]=Math.random()}catch(e){}reqsmall.push(r),reqsmall=new Blob(reqsmall);var ulCalled=!1,ptCalled=!1;