/*
    HTML5 Speedtest v4.1
    by Federico Dossena
    https://github.com/adolfintel/speedtest/
    GNU LGPLv3 License
*///data reported to main thread
function clearRequests(){var e="onprogress",t=null,n="upload";if(xhr){for(var r=0;r<xhr.length;r++){if(useFetchAPI)try{xhr[r].cancelRequested=!0}catch(i){}try{xhr[r][e]=t,xhr[r].onload=t,xhr[r].onerror=t}catch(i){}try{xhr[r][n][e]=t,xhr[r][n].onload=t,xhr[r][n].onerror=t}catch(i){}try{xhr[r].abort()}catch(i){}try{delete xhr[r]}catch(i){}}xhr=t}}function getIp(e){xhr=new XMLHttpRequest,xhr.onload=function(){clientIp=xhr.responseText,e()},xhr.onerror=function(){e()},xhr.open("GET",settings.url_getIp+"?r="+Math.random(),!0),xhr.send()}function getServer(e){var t="Fail",n="setRequestHeader",r="application/json",i={},s=[],o="";xhr=new XMLHttpRequest,xhr.onload=function(){var n=JSON.parse(xhr.responseText);pointsOfTest=n.result;var r=function(e){var n=(new Date).getTime();xhr=new XMLHttpRequest,xhr.onload=function(){var e=(new Date).getTime();o=e-n,o=o.toFixed(2)},xhr.onerror=function(){o=t},xhr.open("GET",e,!1),xhr.send()};for(var u=0;u<pointsOfTest.length;u++){try{r(pointsOfTest[u])}catch(a){o=t}o!=t&&(i[o]=pointsOfTest[u],s.push(o))}s.sort(function(e,t){return e-t}),pot=i[s[0]],settings.url_ping=pot,settings.url_dl=pot+"/download/",settings.url_ul=pot+"/upload",settings.url_getIp="http://icanhazip.com",console.log("Available servers:"+JSON.stringify(i)),console.log("Best point of test: "+pot),e()},xhr.onerror=function(){e()},xhr.open("POST",settings.url_getPointsOfTest,!0),xhr[n]("Content-Type",r),xhr[n]("Accept",r),xhr.send(JSON.stringify({data:{}}))}function dlTest(e){var t=!0,n="bind",r="&ckSize=",i="garbagePhp_chunkSize",s="loaded",o="responseType";if(dlCalled)return;dlCalled=t;var u=0,a=(new Date).getTime(),f=!1;xhr=[];var l=function(e,a){setTimeout(function(){if(testStatus!=1)return;if(useFetchAPI)xhr[e]=fetch(settings.url_dl+"?r="+Math.random()+r+settings[i]).then(function(t){var r=t.body.getReader(),i=function(){return r.read().then(function(t){return t.done?l(e):(u+=t.value.length,xhr[e].cancelRequested&&r.cancel()),i()}[n](this))}[n](this);return i()}[n](this));else{var a=0,c=new XMLHttpRequest;xhr[e]=c,xhr[e].onprogress=function(e){if(testStatus!=1)try{c.abort()}catch(t){}var n=e[s]<=0?0:e[s]-a;if(isNaN(n)||!isFinite(n)||n<0)return;u+=n,a=e[s]}[n](this),xhr[e].onload=function(){try{xhr[e].abort()}catch(t){}l(e,0)}[n](this),xhr[e].onerror=function(){f=t;try{xhr[e].abort()}catch(n){}delete xhr[e]}[n](this);try{settings.xhr_dlUseBlob?xhr[e][o]="blob":xhr[e][o]="arraybuffer"}catch(h){}xhr[e].open("GET",settings.url_dl+"?r="+Math.random()+r+settings[i],t),xhr[e].send()}}[n](this),1+a)}[n](this);for(var c=0;c<settings.xhr_dlMultistream;c++)l(c,100*c);interval=setInterval(function(){var t=(new Date).getTime()-a;if(t<200)return;var n=u/(t/1e3);dlStatus=(n*8/925e3).toFixed(2);if(t/1e3>settings.time_dl||f){if(f||isNaN(dlStatus))dlStatus="Fail";clearRequests(),clearInterval(interval),e()}}[n](this),200)}function ulTest(e){var t=!0,n="bind",r="onprogress",i="upload",s="POST",o="setRequestHeader",u="Content-Encoding",a="identity",f="loaded";if(ulCalled)return;ulCalled=t;var l=0,c=(new Date).getTime(),h=!1;xhr=[];var p=function(e,c){setTimeout(function(){if(testStatus!=3)return;var c=0,d=new XMLHttpRequest;xhr[e]=d;var v;try{xhr[e][i][r],v=!1}catch(m){v=t}v?(xhr[e].onload=function(){l+=262144,p(e,0)},xhr[e].onerror=function(){h=t;try{xhr[e].abort()}catch(n){}delete xhr[e]},xhr[e].open(s,settings.url_ul+"?r="+Math.random(),t),xhr[e][o](u,a),xhr[e].send(reqsmall)):(xhr[e][i][r]=function(e){if(testStatus!=3)try{d.abort()}catch(t){}var n=e[f]<=0?0:e[f]-c;if(isNaN(n)||!isFinite(n)||n<0)return;l+=n,c=e[f]}[n](this),xhr[e][i].onload=function(){p(e,0)}[n](this),xhr[e][i].onerror=function(){h=t;try{xhr[e].abort()}catch(n){}delete xhr[e]}[n](this),xhr[e].open(s,settings.url_ul+"?r="+Math.random(),t),xhr[e][o](u,a),xhr[e].send(req))}[n](this),1)}[n](this);for(var d=0;d<settings.xhr_ulMultistream;d++)p(d,100*d);interval=setInterval(function(){var t=(new Date).getTime()-c;if(t<200)return;var n=l/(t/1e3);ulStatus=(n*8/925e3).toFixed(2);if(t/1e3>settings.time_ul||h){if(h||isNaN(ulStatus))ulStatus="Fail";clearRequests(),clearInterval(interval),e()}}[n](this),200)}function pingTest(e){if(ptCalled)return;ptCalled=!0;var t=null,n=0,r=0,i=0,s=0;xhr=[];var o=function(){t=(new Date).getTime(),xhr[0]=new XMLHttpRequest,xhr[0].onload=function(){if(i==0)t=(new Date).getTime();else{var u=((new Date).getTime()-t)/2,a=Math.abs(u-s);i==1?n=u:(n=n*.9+u*.1,r=a>r?r*.2+a*.8:r*.9+a*.1),s=u}pingStatus=n.toFixed(2),jitterStatus=r.toFixed(2),i++,i<settings.count_ping?o():e()}.bind(this),xhr[0].onerror=function(){packetLoss+=1}.bind(this),xhr[0].open("GET",settings.url_ping+"?r="+Math.random(),!0),xhr[0].send()}.bind(this);o()}var testStatus=0,dlStatus="",ulStatus="",pingStatus="",jitterStatus="",clientIp="",pot="",packetLoss=0,settings={time_ul:15,time_dl:15,count_ping:35,url_dl:"garbage.php",url_ul:"empty.dat",url_ping:"empty.dat",url_getIp:"getIP.php",url_getPointsOfTest:"getPointsOfTest",xhr_dlMultistream:10,xhr_ulMultistream:3,xhr_dlUseBlob:!1,garbagePhp_chunkSize:20,enable_quirks:!0,allow_fetchAPI:!1,force_fetchAPI:!1},xhr=null,interval=null,useFetchAPI=!1;this.addEventListener("message",function(e){var t=";",n="url_getPointsOfTest",r="undefined",i="url_dl",s="url_ul",o="url_ping",u="url_getIp",a="time_dl",f="time_ul",l="enable_quirks",c="allow_fetchAPI",h="test",p="xhr_ulMultistream",d="xhr_dlMultistream",v="garbagePhp_chunkSize",m="count_ping",g="xhr_dlUseBlob",y="force_fetchAPI",b=e.data.split(" ");b[0]=="status"&&postMessage(testStatus+t+dlStatus+t+ulStatus+t+pingStatus+t+clientIp+t+jitterStatus+t+pot+t+packetLoss);if(b[0]=="start"&&testStatus==0){testStatus=1;try{var w=JSON.parse(e.data.substring(5));typeof w[n]!=r&&(settings[n]=w[n]),typeof w[i]!=r&&(settings[i]=w[i]),typeof w[s]!=r&&(settings[s]=w[s]),typeof w[o]!=r&&(settings[o]=w[o]),typeof w[u]!=r&&(settings[u]=w[u]),typeof w[a]!=r&&(settings[a]=w[a]),typeof w[f]!=r&&(settings[f]=w[f]),typeof w[l]!=r&&(settings[l]=w[l]),typeof w[c]!=r&&(settings[c]=w[c]);if(settings[l]){var E=navigator.userAgent;/Firefox.(\d+\.\d+)/i[h](E)&&(settings[p]=1),/Edge.(\d+\.\d+)/i[h](E)&&(settings[d]=3),/Safari.(\d+)/i[h](E)&&!/Chrome.(\d+)/i[h](E)&&(settings[p]=10,settings[v]=5),/Chrome.(\d+)/i[h](E)&&!!self.fetch&&(settings[c]&&(useFetchAPI=!0),settings[d]=5)}typeof w[m]!=r&&(settings[m]=w[m]),typeof w[d]!=r&&(settings[d]=w[d]),typeof w[p]!=r&&(settings[p]=w[p]),typeof w[g]!=r&&(settings[g]=w[g]),typeof w[v]!=r&&(settings[v]=w[v]),typeof w[y]!=r&&(settings[y]=w[y]),settings[c]&&settings[y]&&!!self.fetch&&(useFetchAPI=!0)}catch(e){}console.log(settings),console.log("Fetch API: "+useFetchAPI),getServer(function(){getIp(function(){dlTest(function(){testStatus=2,pingTest(function(){testStatus=3,ulTest(function(){testStatus=4})})})})})}b[0]=="abort"&&(clearRequests(),interval&&clearInterval(interval),testStatus=5,dlStatus="",ulStatus="",pingStatus="",jitterStatus="",pot="")});var dlCalled=!1,r=new ArrayBuffer(1048576);try{r=new Float32Array(r);for(var i=0;i<r.length;i++)r[i]=Math.random()}catch(e){}var req=[],reqsmall=[];for(var i=0;i<20;i++)req.push(r);req=new Blob(req),r=new ArrayBuffer(262144);try{r=new Float32Array(r);for(var i=0;i<r.length;i++)r[i]=Math.random()}catch(e){}reqsmall.push(r),reqsmall=new Blob(reqsmall);var ulCalled=!1,ptCalled=!1;